<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de Phandalin</title>
    <style>
        :root {
            --color-dark: #3c2c23;
            --color-medium: #8b5a2b;
            --color-light: #d9b38c;
            --color-highlight: #ffcc80;
            --color-prosperity: #4caf50;
            --color-security: #f44336;
            --color-population: #2196f3;
            --color-gold: #ffd700;
            --color-taxes: #9c27b0;
            --color-lifestyle: #ff9800;
            --color-upkeep: #795548;
            --color-profit: #009688;
            --color-construction: #607d8b;
        }
        
        body {
            font-family: 'Times New Roman', serif;
            background-color: #f5eee6;
            color: var(--color-dark);
            margin: 0;
            padding: 20px;
            background-image: url('https://uploads.worldanvil.com/uploads/images/d20c4872e0ed7bad967d133c89871048.JPG');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: rgba(255, 253, 248, 0.9);
            padding: 20px;
            border: 3px solid var(--color-medium);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            border-radius: 5px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--color-medium);
            padding-bottom: 15px;
        }
        
        h1 {
            color: var(--color-dark);
            margin: 0;
            font-size: 2.5em;
            text-shadow: 2px 2px 3px rgba(0, 0, 0, 0.1);
        }
        
        .subtitle {
            font-style: italic;
            color: var(--color-medium);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(to bottom right, var(--color-light), #e9d6bd);
            border: 2px solid var(--color-medium);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 3px 3px 7px rgba(0, 0, 0, 0.1);
        }
        
        .stat-title {
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 10px;
            color: var(--color-dark);
            border-bottom: 1px solid var(--color-medium);
            padding-bottom: 5px;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .stat-input {
            width: 80px;
            text-align: center;
            font-size: 1.2em;
            padding: 5px;
            border: 1px solid var(--color-medium);
            border-radius: 4px;
        }
        
        .stat-slider {
            width: 80%;
            margin: 10px 0;
        }
        
        .prosperity { color: var(--color-prosperity); }
        .security { color: var(--color-security); }
        .population { color: var(--color-population); }
        .gold { color: var(--color-gold); }
        .taxes { color: var(--color-taxes); }
        .lifestyle { color: var(--color-lifestyle); }
        .upkeep { color: var(--color-upkeep); }
        .profit { color: var(--color-profit); }
        .construction { color: var(--color-construction); }
        
        .classes-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: white;
            font-size: 0.9em;
        }
        
        .classes-table th, .classes-table td {
            border: 1px solid var(--color-medium);
            padding: 8px;
            text-align: center;
        }
        
        .classes-table th {
            background-color: var(--color-medium);
            color: white;
            position: sticky;
            top: 0;
        }
        
        .classes-table tr:nth-child(even) {
            background-color: var(--color-light);
        }
        
        .table-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }
        
        .tax-info {
            background-color: #f3e5f5;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid var(--color-taxes);
            margin: 20px 0;
        }
        
        .construction-section {
            background-color: #eceff1;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid var(--color-construction);
            margin: 20px 0;
        }
        
        .construction-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .construction-form input, .construction-form select {
            padding: 8px;
            border: 1px solid var(--color-medium);
            border-radius: 4px;
        }
        
        .construction-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .construction-card {
            background: linear-gradient(to bottom right, #e0e0e0, #bdbdbd);
            border: 2px solid var(--color-construction);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 3px 3px 7px rgba(0, 0, 0, 0.1);
        }
        
        .construction-image {
            width: 100%;
            height: 350px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 10px;
            border: 1px solid var(--color-dark);
        }
        
        .construction-level {
            font-size: 1.2em;
            font-weight: bold;
            margin: 5px 0;
            color: var(--color-construction);
        }
        
        .construction-effects {
            font-size: 0.9em;
            margin: 10px 0;
            text-align: left;
            background-color: rgba(255, 255, 255, 0.5);
            padding: 8px;
            border-radius: 4px;
        }
        
        .notes-section {
            margin-top: 30px;
        }
        
        textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid var(--color-medium);
            border-radius: 4px;
            background-color: #fffdf8;
            font-family: inherit;
        }
        
        .comparison {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            font-size: 0.9em;
            color: var(--color-medium);
        }
        
        .button {
            background-color: var(--color-medium);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 1em;
            margin-top: 10px;
        }
        
        .button:hover {
            background-color: var(--color-dark);
        }
        
        .reset-button {
            background-color: #f44336;
        }
        
        .upgrade-button {
            background-color: var(--color-construction);
        }
        
        .remove-button {
            background-color: #f44336;
            padding: 5px 10px;
            font-size: 0.8em;
        }
        
        .info-text {
            font-style: italic;
            color: var(--color-medium);
            margin-top: 5px;
            font-size: 0.9em;
        }
        
        .population-total {
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            color: var(--color-population);
        }
        
        .editable-income {
            width: 60px;
            text-align: center;
            padding: 3px;
            border: 1px solid var(--color-medium);
            border-radius: 3px;
        }
        
        .editable-count {
            width: 60px;
            text-align: center;
            padding: 3px;
            border: 1px solid var(--color-medium);
            border-radius: 3px;
        }
        
        .editable-tax {
            width: 50px;
            text-align: center;
            padding: 3px;
            border: 1px solid var(--color-medium);
            border-radius: 3px;
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .classes-table {
                font-size: 0.8em;
            }
            
            .classes-table th, .classes-table td {
                padding: 5px;
            }
            
            .construction-form {
                grid-template-columns: 1fr;
            }
            
            .construction-list {
                grid-template-columns: 1fr;
            }
            
            .editable-income, .editable-count, .editable-tax {
                width: 40px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Prefeitura de Phandalin</h1>
            <p class="subtitle">Módulo: Phandalin and Below por "Kung Fu"</p>
        </header>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-title">Prosperidade</div>
                <div class="stat-value prosperity" id="prosperity-value">25</div>
                <input type="range" class="stat-slider" id="prosperity-slider" min="0" max="100" value="25">
                <div>0 (Colapso Total) — 100 (Máxima Prosperidade)</div>
                <div class="info-text" id="prosperity-bonus">Bônus de Renda: +12.5%</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-title">Segurança</div>
                <div class="stat-value security" id="security-value">30</div>
                <input type="range" class="stat-slider" id="security-slider" min="0" max="100" value="30">
                <div>0 (Anarquia) — 100 (Totalmente Segura)</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-title">Tesouro (GP)</div>
                <div class="stat-value gold" id="gold-value">500</div>
                <input type="number" class="stat-input" id="gold-input" min="0" value="500">
            </div>
        </div>
        
        <div class="tax-info">
            <h2>Sistema de Impostos</h2>
            
            <div class="stat-title">Arrecadação Mensal de Impostos</div>
            <div class="stat-value taxes" id="tax-revenue-value">15.6 GP</div>
            <div class="info-text" id="construction-upkeep-info">Manutenção de construções: 0 GP</div>
            <button class="button" id="collect-taxes">Coletar Impostos</button>
            <button class="button reset-button" id="reset-data">Resetar Dados</button>
        </div>
        
        <div class="construction-section">
            <h2>Construções da Cidade</h2>
            
            <div class="construction-form">
                <div>
                    <h3>Adicionar Nova Construção</h3>
                    <input type="text" id="construction-name" placeholder="Nome da Construção">
                    <input type="text" id="construction-image" placeholder="URL da Imagem">
                    <select id="construction-type">
                        <option value="security">Segurança</option>
                        <option value="prosperity">Prosperidade</option>
                        <option value="population">População</option>
                        <option value="tax">Impostos</option>
                        <option value="lifestyle">Estilo de Vida</option>
                        <option value="upkeep">Manutenção</option>
                        <option value="other">Outro</option>
                    </select>
                </div>
                <div>
                    <h3>Efeitos da Construção</h3>
                    <input type="number" id="construction-effect-value" placeholder="Valor do Efeito" value="5">
                    <input type="number" id="construction-cost" placeholder="Custo de Construção (GP)" value="100">
                    <input type="number" id="construction-upkeep" placeholder="Manutenção Mensal (GP)" value="10">
                    <button class="button" id="add-construction">Adicionar Construção</button>
                </div>
            </div>
            
            <div class="construction-list" id="construction-list">
                <!-- Construções serão adicionadas aqui dinamicamente -->
            </div>
        </div>
        
        <div class="population-total">
            População Total: <span id="total-population-value">80</span> habitantes
        </div>
        
        <h2>Distribuição de Classes Sociais</h2>
        <div class="table-container">
            <table class="classes-table">
                <thead>
                    <tr>
                        <th>Classe Social</th>
                        <th>% da População</th>
                        <th>Quantidade</th>
                        <th>Renda Mínima/Mês</th>
                        <th>Estilo de Vida/Mês</th>
                        <th>Manutenção/Mês</th>
                        <th>Taxa de Imposto</th>
                        <th>Impostos/Mês</th>
                        <th>Lucro/Mês</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Pobre</td>
                        <td id="poor-percent">60%</td>
                        <td><input type="number" class="editable-count" id="poor-count" min="0" value="48"></td>
                        <td><input type="number" class="editable-income" id="poor-income" min="0" value="6"> gp</td>
                        <td id="poor-lifestyle">3 gp</td>
                        <td id="poor-upkeep">2 gp</td>
                        <td><input type="number" class="editable-tax" id="poor-tax-rate" min="0" max="100" value="10">%</td>
                        <td id="poor-tax">0.6 gp</td>
                        <td id="poor-profit">0.4 gp</td>
                    </tr>
                    <tr>
                        <td>Modesta</td>
                        <td id="modest-percent">30%</td>
                        <td><input type="number" class="editable-count" id="modest-count" min="0" value="24"></td>
                        <td><input type="number" class="editable-income" id="modest-income" min="0" value="30"> gp</td>
                        <td id="modest-lifestyle">15 gp</td>
                        <td id="modest-upkeep">10 gp</td>
                        <td><input type="number" class="editable-tax" id="modest-tax-rate" min="0" max="100" value="10">%</td>
                        <td id="modest-tax">3 gp</td>
                        <td id="modest-profit">2 gp</td>
                    </tr>
                    <tr>
                        <td>Confortável</td>
                        <td id="comfortable-percent">8%</td>
                        <td><input type="number" class="editable-count" id="comfortable-count" min="0" value="6"></td>
                        <td><input type="number" class="editable-income" id="comfortable-income" min="0" value="60"> gp</td>
                        <td id="comfortable-lifestyle">30 gp</td>
                        <td id="comfortable-upkeep">20 gp</td>
                        <td><input type="number" class="editable-tax" id="comfortable-tax-rate" min="0" max="100" value="10">%</td>
                        <td id="comfortable-tax">6 gp</td>
                        <td id="comfortable-profit">4 gp</td>
                    </tr>
                    <tr>
                        <td>Rica</td>
                        <td id="wealthy-percent">2%</td>
                        <td><input type="number" class="editable-count" id="wealthy-count" min="0" value="2"></td>
                        <td><input type="number" class="editable-income" id="wealthy-income" min="0" value="120"> gp</td>
                        <td id="wealthy-lifestyle">60 gp</td>
                        <td id="wealthy-upkeep">40 gp</td>
                        <td><input type="number" class="editable-tax" id="wealthy-tax-rate" min="0" max="100" value="10">%</td>
                        <td id="wealthy-tax">12 gp</td>
                        <td id="wealthy-profit">8 gp</td>
                    </tr>
                    <tr>
                        <td>Aristocrática</td>
                        <td id="aristocratic-percent">0%</td>
                        <td><input type="number" class="editable-count" id="aristocratic-count" min="0" value="0"></td>
                        <td><input type="number" class="editable-income" id="aristocratic-income" min="0" value="300"> gp</td>
                        <td id="aristocratic-lifestyle">150 gp</td>
                        <td id="aristocratic-upkeep">100 gp</td>
                        <td><input type="number" class="editable-tax" id="aristocratic-tax-rate" min="0" max="100" value="10">%</td>
                        <td id="aristocratic-tax">30 gp</td>
                        <td id="aristocratic-profit">20 gp</td>
                    </tr>
                    <tr>
                        <td colspan="2"><strong>Total</strong></td>
                        <td id="total-count">80</td>
                        <td id="total-income">-</td>
                        <td id="total-lifestyle">-</td>
                        <td id="total-upkeep">-</td>
                        <td id="total-tax-rate">-</td>
                        <td id="total-tax">15.6 gp</td>
                        <td id="total-profit">-</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="comparison">
            <div>Phandalin Atual: <span id="current-population">80</span> habitantes</div>
            <div>Baldur's Gate: 125.000 habitantes</div>
        </div>
        
        <div class="notes-section">
            <h2>Anotações e Eventos</h2>
            <textarea id="notes" placeholder="Registre aqui eventos importantes, mudanças na vila, ameaças, etc."></textarea>
        </div>
    </div>

    <script>
        // Elementos do DOM
        const prosperitySlider = document.getElementById('prosperity-slider');
        const prosperityValue = document.getElementById('prosperity-value');
        const prosperityBonus = document.getElementById('prosperity-bonus');
        const securitySlider = document.getElementById('security-slider');
        const securityValue = document.getElementById('security-value');
        const goldInput = document.getElementById('gold-input');
        const goldValue = document.getElementById('gold-value');
        const taxRevenueValue = document.getElementById('tax-revenue-value');
        const constructionUpkeepInfo = document.getElementById('construction-upkeep-info');
        const collectTaxesButton = document.getElementById('collect-taxes');
        const resetButton = document.getElementById('reset-data');
        const addConstructionButton = document.getElementById('add-construction');
        const constructionList = document.getElementById('construction-list');
        const totalPopulationValue = document.getElementById('total-population-value');
        const currentPopulation = document.getElementById('current-population');
        
        // Elementos de contagem de população
        const countInputs = [
            document.getElementById('poor-count'),
            document.getElementById('modest-count'),
            document.getElementById('comfortable-count'),
            document.getElementById('wealthy-count'),
            document.getElementById('aristocratic-count')
        ];
        
        // Elementos de renda editável
        const incomeInputs = [
            document.getElementById('poor-income'),
            document.getElementById('modest-income'),
            document.getElementById('comfortable-income'),
            document.getElementById('wealthy-income'),
            document.getElementById('aristocratic-income')
        ];
        
        // Elementos de taxa de imposto por classe
        const taxRateInputs = [
            document.getElementById('poor-tax-rate'),
            document.getElementById('modest-tax-rate'),
            document.getElementById('comfortable-tax-rate'),
            document.getElementById('wealthy-tax-rate'),
            document.getElementById('aristocratic-tax-rate')
        ];
        
        // Elementos de percentual (apenas para exibição)
        const percentElements = [
            document.getElementById('poor-percent'),
            document.getElementById('modest-percent'),
            document.getElementById('comfortable-percent'),
            document.getElementById('wealthy-percent'),
            document.getElementById('aristocratic-percent')
        ];
        
        // Elementos para contagem
        const countElements = [
            document.getElementById('poor-count'),
            document.getElementById('modest-count'),
            document.getElementById('comfortable-count'),
            document.getElementById('wealthy-count'),
            document.getElementById('aristocratic-count')
        ];
        
        // Valores base para estilo de vida, manutenção e lucro (proporções da renda)
        const lifestyleMultipliers = [0.5, 0.5, 0.5, 0.5, 0.5]; // Estilo de vida = 50% da renda
        const upkeepMultipliers = [0.333, 0.333, 0.333, 0.333, 0.333]; // Manutenção = 33.3% da renda
        const profitMultipliers = [0.067, 0.067, 0.067, 0.067, 0.067]; // Lucro = 6.7% da renda (aprox.)
        
        // Elementos para lifestyle, upkeep, profit e tax
        const lifestyleElements = [
            document.getElementById('poor-lifestyle'),
            document.getElementById('modest-lifestyle'),
            document.getElementById('comfortable-lifestyle'),
            document.getElementById('wealthy-lifestyle'),
            document.getElementById('aristocratic-lifestyle')
        ];
        
        const upkeepElements = [
            document.getElementById('poor-upkeep'),
            document.getElementById('modest-upkeep'),
            document.getElementById('comfortable-upkeep'),
            document.getElementById('wealthy-upkeep'),
            document.getElementById('aristocratic-upkeep')
        ];
        
        const profitElements = [
            document.getElementById('poor-profit'),
            document.getElementById('modest-profit'),
            document.getElementById('comfortable-profit'),
            document.getElementById('wealthy-profit'),
            document.getElementById('aristocratic-profit')
        ];
        
        const taxElements = [
            document.getElementById('poor-tax'),
            document.getElementById('modest-tax'),
            document.getElementById('comfortable-tax'),
            document.getElementById('wealthy-tax'),
            document.getElementById('aristocratic-tax')
        ];
        
        // Elementos totais
        const totalCountElement = document.getElementById('total-count');
        const totalIncomeElement = document.getElementById('total-income');
        const totalLifestyleElement = document.getElementById('total-lifestyle');
        const totalUpkeepElement = document.getElementById('total-upkeep');
        const totalTaxRateElement = document.getElementById('total-tax-rate');
        const totalTaxElement = document.getElementById('total-tax');
        const totalProfitElement = document.getElementById('total-profit');
        
        // Sistema de construções
        let constructions = [];
        let constructionEffects = {
            security: 0,
            prosperity: 0,
            population: 0,
            taxModifier: 0,
            lifestyle: 0, // Novo efeito para estilo de vida
            upkeep: 0     // Novo efeito para manutenção
        };
        
        // Atualizar sliders de prosperidade e segurança
        prosperitySlider.addEventListener('input', function() {
            prosperityValue.textContent = this.value;
            updateProsperityBonus();
            calculateEconomy();
            saveData();
        });
        
        securitySlider.addEventListener('input', function() {
            securityValue.textContent = this.value;
            saveData();
        });
        
        // Sincronizar input de ouro
        goldInput.addEventListener('input', function() {
            goldValue.textContent = this.value;
            saveData();
        });
        
        // Coletar impostos
        collectTaxesButton.addEventListener('click', function() {
            const currentGold = parseInt(goldInput.value) || 0;
            const taxRevenue = parseFloat(taxRevenueValue.textContent) || 0;
            
            // Verificar se há receita suficiente para cobrir a manutenção
            if (taxRevenue < 0) {
                if (!confirm(`Atenção! A manutenção das construções excede a arrecadação em ${Math.abs(taxRevenue)} GP. Continuar irá reduzir seu tesouro.`)) {
                    return;
                }
            }
            
            goldInput.value = currentGold + taxRevenue;
            goldValue.textContent = goldInput.value;
            
            // Registrar no log de eventos
            const notes = document.getElementById('notes');
            const date = new Date().toLocaleDateString();
            const maintenance = calculateTotalConstructionUpkeep();
            notes.value = `[${date}] Impostos coletados: ${taxRevenue.toFixed(1)} GP (Manutenção: ${maintenance.toFixed(1)} GP)\n` + notes.value;
            
            saveData();
        });
        
        // Adicionar construção
        addConstructionButton.addEventListener('click', function() {
            const name = document.getElementById('construction-name').value;
            const imageUrl = document.getElementById('construction-image').value;
            const type = document.getElementById('construction-type').value;
            const effectValue = parseInt(document.getElementById('construction-effect-value').value);
            const cost = parseInt(document.getElementById('construction-cost').value);
            const upkeep = parseInt(document.getElementById('construction-upkeep').value);
            
            if (!name || !imageUrl) {
                alert('Por favor, preencha o nome e a URL da imagem da construção.');
                return;
            }
            
            // Verificar se há ouro suficiente
            const currentGold = parseInt(goldInput.value) || 0;
            if (currentGold < cost) {
                alert('Ouro insuficiente para construir isso!');
                return;
            }
            
            // Deduzir o custo de construção
            goldInput.value = currentGold - cost;
            goldValue.textContent = goldInput.value;
            
            // Adicionar a construção
            const construction = {
                id: Date.now(),
                name,
                imageUrl,
                type,
                effectValue,
                upkeep,
                level: 1
            };
            
            constructions.push(construction);
            updateConstructionEffects();
            updateConstructionsDisplay();
            calculateEconomy();
            saveData();
            
            // Registrar no log de eventos
            const notes = document.getElementById('notes');
            const date = new Date().toLocaleDateString();
            notes.value = `[${date}] Construção concluída: ${name} (Custo: ${cost} GP, Manutenção: ${upkeep} GP/mês)\n` + notes.value;
            
            // Limpar o formulário
            document.getElementById('construction-name').value = '';
            document.getElementById('construction-image').value = '';
            document.getElementById('construction-effect-value').value = '5';
            document.getElementById('construction-cost').value = '100';
            document.getElementById('construction-upkeep').value = '10';
        });
        
        // Resetar dados
        resetButton.addEventListener('click', function() {
            if (confirm('Tem certeza que deseja resetar todos os dados? Isso não pode ser desfeito.')) {
                localStorage.removeItem('phandalinData');
                localStorage.removeItem('phandalinConstructions');
                
                // Resetar valores para os padrões
                prosperitySlider.value = 25;
                prosperityValue.textContent = 25;
                
                securitySlider.value = 30;
                securityValue.textContent = 30;
                
                goldInput.value = 500;
                goldValue.textContent = 500;
                
                // Resetar contagens de população
                countInputs[0].value = 48;
                countInputs[1].value = 24;
                countInputs[2].value = 6;
                countInputs[3].value = 2;
                countInputs[4].value = 0;
                
                // Resetar rendas
                incomeInputs[0].value = 6;
                incomeInputs[1].value = 30;
                incomeInputs[2].value = 60;
                incomeInputs[3].value = 120;
                incomeInputs[4].value = 300;
                
                // Resetar taxas de imposto
                taxRateInputs[0].value = 10;
                taxRateInputs[1].value = 10;
                taxRateInputs[2].value = 10;
                taxRateInputs[3].value = 10;
                taxRateInputs[4].value = 10;
                
                document.getElementById('notes').value = '';
                
                constructions = [];
                constructionEffects = {
                    security: 0,
                    prosperity: 0,
                    population: 0,
                    taxModifier: 0,
                    lifestyle: 0,
                    upkeep: 0
                };
                
                updatePopulationCounts();
                updateProsperityBonus();
                updateConstructionsDisplay();
                calculateEconomy();
            }
        });
        
        // Calcular manutenção total das construções
        function calculateTotalConstructionUpkeep() {
            let total = 0;
            constructions.forEach(construction => {
                total += construction.upkeep * construction.level;
            });
            return total;
        }
        
        // Atualizar contagens de população e percentuais
        function updatePopulationCounts() {
            let totalPopulation = 0;
            
            // Calcular população total
            for (const input of countInputs) {
                totalPopulation += parseInt(input.value || 0);
            }
            
            // Atualizar display da população total
            totalPopulationValue.textContent = totalPopulation;
            currentPopulation.textContent = totalPopulation;
            totalCountElement.textContent = totalPopulation;
            
            // Calcular e atualizar percentuais
            for (let i = 0; i < countInputs.length; i++) {
                const count = parseInt(countInputs[i].value || 0);
                const percent = totalPopulation > 0 ? (count / totalPopulation * 100) : 0;
                percentElements[i].textContent = percent.toFixed(1) + '%';
            }
        }
        
        // Atualizar bônus de prosperidade
        function updateProsperityBonus() {
            const prosperity = parseInt(prosperitySlider.value);
            const prosperityMultiplier = Math.floor(prosperity / 5) * 0.025;
            prosperityBonus.textContent = `Bônus de Renda: +${(prosperityMultiplier * 100).toFixed(1)}%`;
        }
        
        // Atualizar efeitos das construções
        function updateConstructionEffects() {
            // Resetar efeitos
            constructionEffects = {
                security: 0,
                prosperity: 0,
                population: 0,
                taxModifier: 0,
                lifestyle: 0,
                upkeep: 0
            };
            
            // Calcular efeitos totais
            constructions.forEach(construction => {
                switch (construction.type) {
                    case 'security':
                        constructionEffects.security += construction.effectValue * construction.level;
                        break;
                    case 'prosperity':
                        constructionEffects.prosperity += construction.effectValue * construction.level;
                        break;
                    case 'population':
                        constructionEffects.population += construction.effectValue * construction.level;
                        break;
                    case 'tax':
                        constructionEffects.taxModifier += construction.effectValue * construction.level;
                        break;
                    case 'lifestyle':
                        constructionEffects.lifestyle += construction.effectValue * construction.level;
                        break;
                    case 'upkeep':
                        constructionEffects.upkeep += construction.effectValue * construction.level;
                        break;
                }
            });
        }
        
        // Atualizar display das construções
        function updateConstructionsDisplay() {
            constructionList.innerHTML = '';
            
            constructions.forEach(construction => {
                const constructionCard = document.createElement('div');
                constructionCard.className = 'construction-card';
                
                let effectDescription = '';
                switch (construction.type) {
                    case 'security':
                        effectDescription = `+${construction.effectValue * construction.level} Segurança`;
                        break;
                    case 'prosperity':
                        effectDescription = `+${construction.effectValue * construction.level} Prosperidade`;
                        break;
                    case 'population':
                        effectDescription = `+${construction.effectValue * construction.level} População`;
                        break;
                    case 'tax':
                        effectDescription = `${construction.effectValue * construction.level} GP em Impostos`;
                        break;
                    case 'lifestyle':
                        effectDescription = `+${construction.effectValue * construction.level} Estilo de Vida`;
                        break;
                    case 'upkeep':
                        effectDescription = `+${construction.effectValue * construction.level} Manutenção`;
                        break;
                }
                
                constructionCard.innerHTML = `
                    <img src="${construction.imageUrl}" alt="${construction.name}" class="construction-image">
                    <h3>${construction.name}</h3>
                    <div class="construction-level">Nível ${construction.level}</div>
                    <div class="construction-effects">
                        <p><strong>Efeito:</strong> ${effectDescription}</p>
                        <p><strong>Manutenção:</strong> ${construction.upkeep * construction.level} GP/mês</p>
                    </div>
                    <button class="button upgrade-button" data-id="${construction.id}">Upgrade (${construction.upkeep * (construction.level + 1)} GP/mês)</button>
                    <button class="button remove-button" data-id="${construction.id}">Remover</button>
                `;
                
                constructionList.appendChild(constructionCard);
            });
            
            // Adicionar event listeners para os botões
            document.querySelectorAll('.upgrade-button').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    upgradeConstruction(id);
                });
            });
            
            document.querySelectorAll('.remove-button').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    removeConstruction(id);
                });
            });
        }
        
        // Melhorar construção
        function upgradeConstruction(id) {
            const construction = constructions.find(c => c.id === id);
            if (!construction) return;
            
            // Verificar se há ouro suficiente para a manutenção adicional
            const currentGold = parseInt(goldInput.value) || 0;
            const upkeepIncrease = construction.upkeep; // Aumento da manutenção por nível
            
            construction.level++;
            updateConstructionEffects();
            updateConstructionsDisplay();
            calculateEconomy();
            saveData();
            
            // Registrar no log de eventos
            const notes = document.getElementById('notes');
            const date = new Date().toLocaleDateString();
            notes.value = `[${date}] ${construction.name} melhorada para nível ${construction.level} (Manutenção adicional: ${upkeepIncrease} GP/mês)\n` + notes.value;
        }
        
        // Remover construção
        function removeConstruction(id) {
            if (!confirm('Tem certeza que deseja remover esta construção?')) return;
            
            const index = constructions.findIndex(c => c.id === id);
            if (index === -1) return;
            
            const construction = constructions[index];
            
            // Registrar no log de eventos
            const notes = document.getElementById('notes');
            const date = new Date().toLocaleDateString();
            notes.value = `[${date}] ${construction.name} foi demolida\n` + notes.value;
            
            constructions.splice(index, 1);
            updateConstructionEffects();
            updateConstructionsDisplay();
            calculateEconomy();
            saveData();
        }
        
        // Calcular economia com base na prosperidade e taxas de impostos individuais
        function calculateEconomy() {
            const baseProsperity = parseInt(prosperitySlider.value);
            const baseSecurity = parseInt(securitySlider.value);
            
            // Aplicar efeitos das construções
            const effectiveProsperity = Math.max(0, Math.min(100, baseProsperity + constructionEffects.prosperity));
            const effectiveSecurity = Math.max(0, Math.min(100, baseSecurity + constructionEffects.security));
            
            // Atualizar displays com valores efetivos
            prosperityValue.textContent = effectiveProsperity;
            securityValue.textContent = effectiveSecurity;
            
            const prosperityMultiplier = 1 + (Math.floor(effectiveProsperity / 5) * 0.025);
            prosperityBonus.textContent = `Bônus de Renda: +${((prosperityMultiplier - 1) * 100).toFixed(1)}%`;
            
            let totalIncome = 0;
            let totalLifestyle = 0;
            let totalUpkeep = 0;
            let totalTaxRevenue = 0;
            let totalProfit = 0;
            let totalTaxRate = 0;
            let classCount = 0;
            
            // Calcular manutenção total das construções
            const totalConstructionUpkeep = calculateTotalConstructionUpkeep();
            
            for (let i = 0; i < countInputs.length; i++) {
                const count = parseInt(countInputs[i].value || 0);
                const baseIncome = parseFloat(incomeInputs[i].value || 0);
                const taxRate = parseFloat(taxRateInputs[i].value || 0);
                
                // Calcular valores ajustados pela prosperidade
                const income = baseIncome * prosperityMultiplier;
                
                // Aplicar efeitos das construções no estilo de vida e manutenção
                const lifestyleMultiplier = Math.max(0, lifestyleMultipliers[i] + constructionEffects.lifestyle / 100);
                const upkeepMultiplier = Math.max(0, upkeepMultipliers[i] + constructionEffects.upkeep / 100);
                
                const lifestyle = income * lifestyleMultiplier;
                const upkeep = income * upkeepMultiplier;
                
                // Calcular impostos com taxa individual
                const tax = income * (taxRate / 100);
                const profit = income - lifestyle - upkeep - tax;
                
                // Atualizar displays
                lifestyleElements[i].textContent = `${lifestyle.toFixed(1)} gp`;
                upkeepElements[i].textContent = `${upkeep.toFixed(1)} gp`;
                taxElements[i].textContent = `${tax.toFixed(1)} gp`;
                profitElements[i].textContent = `${profit.toFixed(1)} gp`;
                
                // Calcular totais
                totalIncome += income * count;
                totalLifestyle += lifestyle * count;
                totalUpkeep += upkeep * count;
                totalTaxRevenue += tax * count;
                totalProfit += profit * count;
                
                // Calcular média da taxa de imposto (apenas para classes com população)
                if (count > 0) {
                    totalTaxRate += taxRate;
                    classCount++;
                }
            }
            
            // Aplicar modificador de impostos das construções
            totalTaxRevenue += constructionEffects.taxModifier;
            
            // Subtrair a manutenção das construções da arrecadação de impostos
            totalTaxRevenue -= totalConstructionUpkeep;
            
            // Calcular taxa média de imposto
            const averageTaxRate = classCount > 0 ? (totalTaxRate / classCount) : 0;
            
            // Atualizar totais
            totalIncomeElement.textContent = `${totalIncome.toFixed(1)} gp`;
            totalLifestyleElement.textContent = `${totalLifestyle.toFixed(1)} gp`;
            totalUpkeepElement.textContent = `${totalUpkeep.toFixed(1)} gp`;
            totalTaxRateElement.textContent = `${averageTaxRate.toFixed(1)}%`;
            totalTaxElement.textContent = `${totalTaxRevenue.toFixed(1)} gp`;
            totalProfitElement.textContent = `${totalProfit.toFixed(1)} gp`;
            
            // Atualizar arrecadação de impostos e informação de manutenção
            taxRevenueValue.textContent = totalTaxRevenue.toFixed(1);
            constructionUpkeepInfo.textContent = `Manutenção de construções: ${totalConstructionUpkeep.toFixed(1)} GP`;
            
            // Destacar se a manutenção está causando deficit
            if (totalConstructionUpkeep > 0) {
                if (totalTaxRevenue < 0) {
                    constructionUpkeepInfo.style.color = '#f44336';
                    constructionUpkeepInfo.innerHTML += ` <span style="color:#f44336">(Déficit: ${Math.abs(totalTaxRevenue).toFixed(1)} GP)</span>`;
                } else {
                    constructionUpkeepInfo.style.color = '';
                }
            }
        }
        
        // Adicionar listeners para os inputs de contagem, renda e taxa de imposto
        for (const input of countInputs) {
            input.addEventListener('input', function() {
                updatePopulationCounts();
                calculateEconomy();
                saveData();
            });
        }
        
        for (const input of incomeInputs) {
            input.addEventListener('input', function() {
                calculateEconomy();
                saveData();
            });
        }
        
        for (const input of taxRateInputs) {
            input.addEventListener('input', function() {
                calculateEconomy();
                saveData();
            });
        }
        
        // Salvar dados no localStorage
        function saveData() {
            const data = {
                prosperity: prosperitySlider.value,
                security: securitySlider.value,
                gold: goldInput.value,
                poorCount: countInputs[0].value,
                modestCount: countInputs[1].value,
                comfortableCount: countInputs[2].value,
                wealthyCount: countInputs[3].value,
                aristocraticCount: countInputs[4].value,
                poorIncome: incomeInputs[0].value,
                modestIncome: incomeInputs[1].value,
                comfortableIncome: incomeInputs[2].value,
                wealthyIncome: incomeInputs[3].value,
                aristocraticIncome: incomeInputs[4].value,
                poorTaxRate: taxRateInputs[0].value,
                modestTaxRate: taxRateInputs[1].value,
                comfortableTaxRate: taxRateInputs[2].value,
                wealthyTaxRate: taxRateInputs[3].value,
                aristocraticTaxRate: taxRateInputs[4].value,
                notes: document.getElementById('notes').value,
                constructions: constructions
            };
            localStorage.setItem('phandalinData', JSON.stringify(data));
        }
        
        // Carregar dados do localStorage
        function loadData() {
            const savedData = localStorage.getItem('phandalinData');
            if (savedData) {
                const data = JSON.parse(savedData);
                
                // Restaurar valores dos controles
                prosperitySlider.value = data.prosperity;
                prosperityValue.textContent = data.prosperity;
                
                securitySlider.value = data.security;
                securityValue.textContent = data.security;
                
                goldInput.value = data.gold;
                goldValue.textContent = data.gold;
                
                // Restaurar contagens de população
                countInputs[0].value = data.poorCount || 48;
                countInputs[1].value = data.modestCount || 24;
                countInputs[2].value = data.comfortableCount || 6;
                countInputs[3].value = data.wealthyCount || 2;
                countInputs[4].value = data.aristocraticCount || 0;
                
                // Restaurar rendas
                incomeInputs[0].value = data.poorIncome || 6;
                incomeInputs[1].value = data.modestIncome || 30;
                incomeInputs[2].value = data.comfortableIncome || 60;
                incomeInputs[3].value = data.wealthyIncome || 120;
                incomeInputs[4].value = data.aristocraticIncome || 300;
                
                // Restaurar taxas de imposto
                taxRateInputs[0].value = data.poorTaxRate || 10;
                taxRateInputs[1].value = data.modestTaxRate || 10;
                taxRateInputs[2].value = data.comfortableTaxRate || 10;
                taxRateInputs[3].value = data.wealthyTaxRate || 10;
                taxRateInputs[4].value = data.aristocraticTaxRate || 10;
                
                document.getElementById('notes').value = data.notes;
                
                // Carregar construções
                if (data.constructions) {
                    constructions = data.constructions;
                    updateConstructionEffects();
                    updateConstructionsDisplay();
                }
                
                // Atualizar displays
                updatePopulationCounts();
                updateProsperityBonus();
                calculateEconomy();
            }
        }
        
        // Inicializar
        window.addEventListener('load', function() {
            loadData();
        });
        
        updatePopulationCounts();
        updateProsperityBonus();
        calculateEconomy();
    </script>
</body>
</html>
